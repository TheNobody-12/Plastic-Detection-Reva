{% extends "base.html" %}
{% block body %}
<center>
    <h1 style="margin: 50px 0px;">Object Detection</h1>
</center>
<!-- Upload Section -->
<div class="container mt-5">
    <div class="row">
        <div class="col-md-6 mx-auto">
            <div class="card">
                <div class="card-header">
                    Upload Drone Image
                </div>
                <div class="card-body">
                    <form id="uploadForm">
                        <div class="form-group">
                            <br><input type="file" idtype="submit" class="btn btn-primary" id="uploadInput"
                                accept="image/*" required>
                            <!-- <button idtype="submit" class="btn btn-primary" id="uploadInput">Upload</button> -->
                            <br>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS and jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<style>
    /* CSS for the pop-up */
    .popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 999;
        justify-content: center;
        align-items: center;
    }

    .popup img {
        max-width: 90%;
        max-height: 90%;
    }

    /* Flex container for centering */
    .canvas-container {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
    }

    /* Style for the canvas */
    canvas {
        max-width: 400px;
        max-height: 100%;
        border: 2px solid #000;
    }
</style>

<!-- HTML content -->
<div class="popup" id="popup">
    <img src="" alt="Enlarged Image" id="popupImage">
</div>
<br> <br>
<!-- Canvas -->
<div class="canvas-container" >
    <canvas id="canvas"></canvas>
</div>

<!-- Geolocation -->
<div id="geolocation"></div>

<!-- Location -->
<div id="locationDiv"></div>

<script>
    // JavaScript code for pop-up behavior
    const canvas = document.getElementById("canvas");
    const popup = document.getElementById("popup");
    const popupImage = document.getElementById("popupImage");

    canvas.addEventListener("click", () => {
        const imgSrc = canvas.toDataURL(); // Get the image data from the canvas
        popupImage.src = imgSrc; // Set the source of the pop-up image to the canvas image
        popup.style.display = "flex"; // Display the pop-up
    });

    popup.addEventListener("click", () => {
        popup.style.display = "none"; // Hide the pop-up when clicked outside the image
    });

</script>

<br> <br>
<center>
    <button type="button" class="btn btn-success"> <a href="/db" style="color: rgb(255, 255, 255);"> Get
        Database</a> </button>
<br> <br>
    <button type="button" class="btn btn-success"> <a href="/linecharts.html" style="color: rgb(255, 255, 255);"> Get
            Visualizations</a> </button>
</center>
<!-- <div id="objectTable"></div> -->
<script>

    const input = document.getElementById("uploadInput");
    const results = document.getElementById("result");
    const geolocationDiv = document.getElementById("geolocation");
    const objectTableDiv = document.getElementById("objectTable");
    input.addEventListener("change", async (event) => {
        const data = new FormData();
        data.append("image_file", event.target.files[0], event.target.files[0].name);
        const response = await fetch("/detect", {
            method: "post",
            body: data
        });

        const boxes = await response.json();
        draw_image_and_boxes(event.target.files[0], boxes);


            fetch(`/get_lat_lon/${event.target.files[0].name}`)
            .then(response => response.json())
            .then(data => {
                console.log("Response data:", data); // Check the data received from the Flask route

                // Update the HTML elements with latitude and longitude
                geolocationDiv.innerHTML = `<h1>Latitude: <span id="latitude">${data[0]}</span></h1>
                                            <h1>Longitude: <span id="longitude">${data[1]}</span></h1>`;

                // Fetch location address using the latitude and longitude
                fetch(`/get_location/${data[0]}/${data[1]}`)
                    .then(response => response.json())
                    .then(locationData => {
                        console.log("Location data:", locationData);
                        // Display the location address on the webpage
                        const locationDiv = document.getElementById("locationDiv");
                        locationDiv.innerHTML = `<h1>Location: ${locationData.address}</h1>
                                                <h2>Country: ${locationData.country}</h2>
                                      <h2>Postal Code: ${locationData.postcode}</h2>`;
                    })
                    .catch(error => console.error("Error fetching location data:", error));
            })
            .catch(error => console.error("Error fetching data:", error));

           const databaseResponse = await fetch("/database");
        if (databaseResponse.ok) {
            const databaseData = await databaseResponse.json();
            displayDatabaseData(databaseData);
        }
    });


    function draw_image_and_boxes(file, boxes) {
        const img = new Image()
        img.src = URL.createObjectURL(file);
        img.onload = () => {
            const canvas = document.querySelector("canvas");
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0);
            ctx.strokeStyle = "#00FF00";
            ctx.lineWidth = 3;
            ctx.font = "18px serif";
            boxes.forEach(([x1, y1, x2, y2, label]) => {
                ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
                ctx.fillStyle = "#00ff00";
                const width = ctx.measureText(label).width;
                ctx.fillRect(x1, y1, width + 10, 25);
                ctx.fillStyle = "#000000";
                ctx.fillText(label, x1, y1 + 18);
            });
        }
    }
</script>

{% endblock body %}